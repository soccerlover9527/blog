<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Mvcc - 融融冶冶黄</title><meta name=Description content="This is my poor blog"><meta property="og:title" content="Mvcc"><meta property="og:description" content="MVCC 简介 MVCC，即Multi-Version Concurrency Control （多版本并发控制）。它是一种并发控制的方法，一般在数据库管理系统中，实现对数据库的并发访问。 InnoDB 是一个支持MVCC存储引擎。它保留有关已更改行的旧版本的信息，以支持并发和回滚等事务功能。旧版本信息存储在被称为回滚段（roll segment）的数据结构中的系统表空间或者 undo 表空间中。 InnoDB 使用回滚段中的信息来执行事务回滚中所需的撤消操作。它还使用这些信息来构建行的早期版本以进行一致的读取。
相关基本概念点 事务版本号 在每次事务开始都会获取一个自增的事务ID，通过这个ID我们可以判断事务执行的先后顺序。
隐式字段 在内部，InnoDB 存储在数据库中的每一行都有三个隐式字段：
DB_TRX_ID 标识插入或者更新该行的最新的事务的id。（删除在事务中也会被视为更新） DB_ROLL_PTR 该指针指向上文提到的回滚段中的 undo log，也就是上一个版本的该行记录。 DB_ROW_ID 隐含的自增主键，如果主键不是自增这行没有使用 上图是在只有一个事务（10001）进行操作时一行记录的状态。
版本链 当多个事务并行的更新某一行的数据时，不同事物对改行数据的修改会产生多个版本，然后通过回滚指针（DB_ROLL_PTR）连成一个链表，这个就是版本链，如下图所示。
可以看见，事务链是通过（DB_ROLL_PTR）进行关联，且存放在 undo log 中。
Undo log 回滚日志，用于事务回滚时恢复上一个版本的数据，记录的是当前事务的反向操作，例如，该事物插入了一条数据，那么 undo log 记录的是一个 DELETE 操作，如果是一个 UPDATE 操作，那么 undo log 记录的是 UPDATE 到原始数据的操作。
所以 undo log 可以分为两类 undo log：
insert undo log 记录 INSERT 语句的 undo log
update undo log 记录 UPDATE DELETE 语句的 undo log"><meta property="og:type" content="article"><meta property="og:url" content="https://soccerlover9527.github.io/posts/posts/databases/mysql/mvcc/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-23T20:55:10+08:00"><meta property="article:modified_time" content="2023-04-23T20:55:10+08:00"><meta property="og:site_name" content="融融冶冶黄"><meta name=twitter:card content="summary"><meta name=twitter:title content="Mvcc"><meta name=twitter:description content="MVCC 简介 MVCC，即Multi-Version Concurrency Control （多版本并发控制）。它是一种并发控制的方法，一般在数据库管理系统中，实现对数据库的并发访问。 InnoDB 是一个支持MVCC存储引擎。它保留有关已更改行的旧版本的信息，以支持并发和回滚等事务功能。旧版本信息存储在被称为回滚段（roll segment）的数据结构中的系统表空间或者 undo 表空间中。 InnoDB 使用回滚段中的信息来执行事务回滚中所需的撤消操作。它还使用这些信息来构建行的早期版本以进行一致的读取。
相关基本概念点 事务版本号 在每次事务开始都会获取一个自增的事务ID，通过这个ID我们可以判断事务执行的先后顺序。
隐式字段 在内部，InnoDB 存储在数据库中的每一行都有三个隐式字段：
DB_TRX_ID 标识插入或者更新该行的最新的事务的id。（删除在事务中也会被视为更新） DB_ROLL_PTR 该指针指向上文提到的回滚段中的 undo log，也就是上一个版本的该行记录。 DB_ROW_ID 隐含的自增主键，如果主键不是自增这行没有使用 上图是在只有一个事务（10001）进行操作时一行记录的状态。
版本链 当多个事务并行的更新某一行的数据时，不同事物对改行数据的修改会产生多个版本，然后通过回滚指针（DB_ROLL_PTR）连成一个链表，这个就是版本链，如下图所示。
可以看见，事务链是通过（DB_ROLL_PTR）进行关联，且存放在 undo log 中。
Undo log 回滚日志，用于事务回滚时恢复上一个版本的数据，记录的是当前事务的反向操作，例如，该事物插入了一条数据，那么 undo log 记录的是一个 DELETE 操作，如果是一个 UPDATE 操作，那么 undo log 记录的是 UPDATE 到原始数据的操作。
所以 undo log 可以分为两类 undo log：
insert undo log 记录 INSERT 语句的 undo log
update undo log 记录 UPDATE DELETE 语句的 undo log"><meta name=application-name content="这是一个简洁的 blog"><meta name=apple-mobile-web-app-title content="这是一个简洁的 blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://soccerlover9527.github.io/posts/posts/databases/mysql/mvcc/><link rel=prev href=https://soccerlover9527.github.io/posts/posts/databases/mysql/mysql%E4%B8%89%E5%A4%A7%E6%97%A5%E5%BF%97/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/posts/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Mvcc","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/soccerlover9527.github.io\/posts\/posts\/databases\/mysql\/mvcc\/"},"genre":"posts","keywords":"Mysql, 数据库, 事务, MVCC","wordcount":189,"url":"https:\/\/soccerlover9527.github.io\/posts\/posts\/databases\/mysql\/mvcc\/","datePublished":"2023-04-23T20:55:10+08:00","dateModified":"2023-04-23T20:55:10+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"soccerlover"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/posts/ title=融融冶冶黄>融融冶冶黄</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>首页 </a><a class=menu-item href=/posts/posts/>timeline </a><a class=menu-item href=/posts/tags/>标签 </a><a class=menu-item href=/posts/categories/>分类 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/posts/ title=融融冶冶黄>融融冶冶黄</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>首页</a><a class=menu-item href=/posts/posts/ title>timeline</a><a class=menu-item href=/posts/tags/ title>标签</a><a class=menu-item href=/posts/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Mvcc</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/posts/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>soccerlover</a>
</span>&nbsp;<span class=post-category>included in <a href=/posts/categories/mysql/><i class="far fa-folder fa-fw" aria-hidden=true></i>Mysql</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-04-23>2023-04-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;189 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;One minute&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#mvcc-简介>MVCC 简介</a></li><li><a href=#相关基本概念点>相关基本概念点</a></li><li><a href=#mvcc-与-rc-rr>MVCC 与 RC RR</a></li></ul></li></ul></nav></div></div><div class=content id=content><h3 id=mvcc-简介>MVCC 简介</h3><p>MVCC，即Multi-Version Concurrency Control （多版本并发控制）。它是一种并发控制的方法，一般在数据库管理系统中，实现对数据库的并发访问。
InnoDB 是一个支持MVCC存储引擎。它保留有关已更改行的旧版本的信息，以支持并发和回滚等事务功能。旧版本信息存储在被称为回滚段（roll segment）的数据结构中的系统表空间或者 undo 表空间中。
InnoDB 使用回滚段中的信息来执行事务回滚中所需的撤消操作。它还使用这些信息来构建行的早期版本以进行一致的读取。</p><h3 id=相关基本概念点>相关基本概念点</h3><h4 id=事务版本号>事务版本号</h4><p>在每次事务开始都会获取一个自增的事务ID，通过这个ID我们可以判断事务执行的先后顺序。</p><h4 id=隐式字段>隐式字段</h4><p>在内部，InnoDB 存储在数据库中的每一行都有三个隐式字段：</p><ul><li>DB_TRX_ID 标识插入或者更新该行的最新的事务的id。（删除在事务中也会被视为更新）</li><li>DB_ROLL_PTR 该指针指向上文提到的回滚段中的 undo log，也就是上一个版本的该行记录。</li><li>DB_ROW_ID 隐含的自增主键，如果主键不是自增这行没有使用</li></ul><p><img class=lazyload src=/posts/svg/loading.min.svg data-src=/images/database-mysql-mvcc-1.png data-srcset="/images/database-mysql-mvcc-1.png, /images/database-mysql-mvcc-1.png 1.5x, /images/database-mysql-mvcc-1.png 2x" data-sizes=auto alt=/images/database-mysql-mvcc-1.png title=databasemysqlmvcc1></p><p>上图是在只有一个事务（10001）进行操作时一行记录的状态。</p><h4 id=版本链>版本链</h4><p>当多个事务并行的更新某一行的数据时，不同事物对改行数据的修改会产生多个版本，然后通过回滚指针（DB_ROLL_PTR）连成一个链表，这个就是版本链，如下图所示。</p><p><img class=lazyload src=/posts/svg/loading.min.svg data-src=/images/database-mysql-mvcc-2.PNG data-srcset="/images/database-mysql-mvcc-2.PNG, /images/database-mysql-mvcc-2.PNG 1.5x, /images/database-mysql-mvcc-2.PNG 2x" data-sizes=auto alt=/images/database-mysql-mvcc-2.PNG title=databasemysqlmvcc1></p><p>可以看见，事务链是通过（DB_ROLL_PTR）进行关联，且存放在 undo log 中。</p><h4 id=undo-log>Undo log</h4><p><strong>回滚日志</strong>，用于事务回滚时恢复上一个版本的数据，记录的是当前事务的反向操作，例如，该事物插入了一条数据，那么 undo log 记录的是一个 DELETE 操作，如果是一个 UPDATE 操作，那么 undo log 记录的是 UPDATE 到原始数据的操作。</p><p>所以 undo log 可以分为两类 undo log：</p><ul><li><h6 id=insert-undo-log>insert undo log</h6></li></ul><p>记录 INSERT 语句的 undo log</p><ul><li><h6 id=update-undo-log>update undo log</h6></li></ul><p>记录 UPDATE DELETE 语句的 undo log</p><h4 id=快照读和当前读>快照读和当前读</h4><ul><li><h6 id=快照读>快照读</h6></li></ul><p>读取的是当前记录的可见的版本，也就是最新的事务更新的版本即使这个事务没有被提交。这种读取不会加锁，普通的 SELECT 语句都是快照读。</p><ul><li><h6 id=当前读>当前读</h6></li></ul><p>当前读, 读取的是最新版本也就是最新的事务提交后的数据版本, 并且对读取的记录加锁, 阻塞其他事务同时改动相同记录，避免出现安全问题。</p><h4 id=read-view-与快照读>Read View 与快照读</h4><p>read view 是事务执行时产生的读视图，主要是用来做可见性判断的，即判断当前事务可以看见版本链中哪个版本的数据。</p><p>想要了解 read view 是如何保证事务可见性的判断，首先要了解它的几个重要属性：</p><ul><li>m_ids: 当前行中的活跃事务id（未提交事务），它组成了一个 list</li><li>min_limit_id:创建当前快照时最小的未提交事务的 ID，即 m_ids 中的最小值</li><li>max_limit_id: 创建当前快照时，系统应该分配给下一个事务的 id 值</li><li>creator_trx_id: 创建该快照的当前事务的 id</li></ul><p>上面几个属性是如何控制数据对于事务的可见性的呢，有以下几个规则</p><ol><li><p>如果该版本的数据大于 max_limit_id，那么说明这个数据是在这个事务之后创建的，对当前事务是不可见的。</p></li><li><p>如果该版本的数据小于 min_limit_id，那么说明这个数据在这个事务生成ReadView时已经被提交（因为m_ids中是活跃的事务，如果都不在 m_ids 中还小于最小事务ID，那么说明这个事务已经被提交了），对于该事物是可见的。</p></li><li><p>如果该版本数据 min_limit_id &lt;= trx_id &lt; max_limit_id，还需要分三个情况 进行考虑</p><p>[1] 如果这个数据的版本等于当前事务版本，那么当然是可见的</p><p>[2] 如果在 m_ids 中又不是当前事务产生的版本记录，那么说明该版本数据没有被提交，对于该事物是不可见的。</p><p>[3] 如果不在 m_ids 中，那么说明当前版本数据事务已经被提交，对于当前事务是可见的</p></li></ol><h3 id=mvcc-与-rc-rr>MVCC 与 RC RR</h3><p>在经过上面知识点的铺垫，介绍一下基于 MVCC 非锁定一致性读是怎么样的流程</p><ol><li>开启事务，获取自己的自增事务ID</li><li>进行非锁定读，创建 Read View</li><li>查询数据当前版本，与 Read View 中的事务版本号进行比较</li><li>如果不符合 Read view 中的可见性规则，那么查询 undo log 中历史版本链</li><li>直到满足规则，返回数据</li></ol><p>那么 RC 与 RR 都使用到了 MVCC 读，有何异同呢</p><ul><li>RC： 读取已提交/不可重复读</li></ul><p>在 RC 隔离级别下，同一个事务，每一次 SELECT 都会产生一个 新的Read View，那么就导致了 两次创建 Read view 的途中，如果有其他事务提交，会导致每次获取到的 max_limit_id 增大，那么提交事务的数据版本肯定是在 m_ids 之外且不大于 max_limit_id 满足Read view 可见性规则 3.3。所以造成两次读取的数据不一致</p><ul><li>RR： 可重复读</li></ul><p>在 RR 隔离级别下，同一个事务，只会获取一次Read view，在整个事务中，都是使用同一个Read view，从而保证每次查询的数据是一致的。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-04-23</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://soccerlover9527.github.io/posts/posts/databases/mysql/mvcc/ data-title=Mvcc data-hashtags=Mysql,数据库,事务,MVCC><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://soccerlover9527.github.io/posts/posts/databases/mysql/mvcc/ data-hashtag=Mysql><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://soccerlover9527.github.io/posts/posts/databases/mysql/mvcc/ data-title=Mvcc><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://soccerlover9527.github.io/posts/posts/databases/mysql/mvcc/ data-title=Mvcc><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://soccerlover9527.github.io/posts/posts/databases/mysql/mvcc/ data-title=Mvcc><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/posts/tags/mysql/>Mysql</a>,&nbsp;<a href=/posts/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>数据库</a>,&nbsp;<a href=/posts/tags/%E4%BA%8B%E5%8A%A1/>事务</a>,&nbsp;<a href=/posts/tags/mvcc/>MVCC</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/posts/>Home</a></span></section></div><div class=post-nav><a href=/posts/posts/databases/mysql/mysql%E4%B8%89%E5%A4%A7%E6%97%A5%E5%BF%97/ class=prev rel=prev title="Mysql 三大日志"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Mysql 三大日志</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.111.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/posts/ target=_blank>融融冶冶黄</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},lightgallery:!0,twemoji:!0}</script><script type=text/javascript src=/posts/js/theme.min.js></script></body></html>